name: Build and Release Matches Card

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Podaj numer wersji (np. 0.3.507)"
        required: true

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: üß© Checkout repo
        uses: actions/checkout@v4

      - name: üî¢ Pobierz wersjƒô
        id: v
        run: |
          echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_ENV

      #
      # 1Ô∏è‚É£  Aktualizacja numeru wersji w plikach
      #
      - name: üìù Aktualizacja manifest.json
        run: |
          jq ".version = \"$VERSION\"" manifest.json > manifest.tmp.json
          mv manifest.tmp.json manifest.json

      - name: üìù Aktualizacja hacs.json
        run: |
          if [ -f hacs.json ]; then
            jq ". | .version = \"$VERSION\"" hacs.json > hacs.tmp.json || true
            mv hacs.tmp.json hacs.json || true
          fi

      - name: üìù Aktualizacja README.md (opcjonalnie)
        run: |
          if grep -q "0.3." README.md; then
            sed -i "s/0\\.3\\.[0-9][0-9]*/$VERSION/g" README.md
          fi

      - name: üìù Aktualizacja info.md (opcjonalnie)
        run: |
          if grep -q "0.3." info.md; then
            sed -i "s/0\\.3\\.[0-9][0-9]*/$VERSION/g" info.md
          fi

      #
      # 2Ô∏è‚É£  Commit wersji
      #
      - name: üíæ Commit zmian
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add manifest.json hacs.json README.md info.md || true
          git commit -m "Automatyczna aktualizacja wersji do $VERSION" || echo "Brak zmian do commitowania"
          git push

      #
      # 3Ô∏è‚É£  Budowanie ZIPa bez folderu w ≈õrodku
      #
      - name: üì¶ Tworzenie ZIP zgodnego z HACS
        run: |
          mkdir release-temp
          cp -r matches-card.js matches-card-editor.js manifest.json hacs.json README.md info.md logo release-temp/
          cd release-temp
          zip -r ../matches-card-${VERSION}.zip *
          cd ..
          rm -rf release-temp

      #
      # 4Ô∏è‚É£  Tworzenie taga (je≈õli nie istnieje)
      #
      - name: üè∑Ô∏è Tworzenie taga
        run: |
          git tag -fa "${VERSION}" -m "Release $VERSION"
          git push origin "${VERSION}" --force

      #
      # 5Ô∏è‚É£ Release GitHub
      #
      - name: üöÄ Publikacja release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.VERSION }}
          name: Matches Card ${{ env.VERSION }}
          body: |
            Automatycznie zbudowana wersja karty Matches Card.

            ‚úî zawiera matches-card.js  
            ‚úî zawiera matches-card-editor.js  
            ‚úî poprawna struktura ZIP  
            ‚úî HACS content_in_root: OK  

          files: matches-card-${{ env.VERSION }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
