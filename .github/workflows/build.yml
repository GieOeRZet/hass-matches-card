name: Build and release Matches Card

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Podaj numer wersji (np. 0.3.038)'
        required: true
  push:
    tags:
      - "[0-9]+.[0-9]+.[0-9]+"

jobs:
  build-release:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ§° Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: ğŸ“¦ Install dependencies
        run: npm install

      - name: ğŸ—ï¸ Build card (Rollup)
        run: npm run build

      - name: ğŸ’¾ Commit built file to repo (for HACS compliance)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add matches-card.js
          git commit -m "build: include matches-card.js for HACS compliance" || echo "No changes to commit"
          git push origin HEAD:main

      - name: ğŸ“ Update manifest.json & hacs.json version
        run: |
          VERSION=${{ github.event.inputs.version }}
          echo "ğŸ”– Ustawiam wersjÄ™: $VERSION"

          # podmiana w manifest.json
          if grep -q '"version":' manifest.json; then
            sed -i "s/\"version\": \".*\"/\"version\": \"$VERSION\"/" manifest.json
          else
            sed -i "1s/^/{\n  \"version\": \"$VERSION\",/" manifest.json
          fi

          # podmiana w hacs.json
          if grep -q '"version":' hacs.json; then
            sed -i "s/\"version\": \".*\"/\"version\": \"$VERSION\"/" hacs.json
          else
            sed -i "2i  \"version\": \"$VERSION\"," hacs.json
          fi

          echo "âœ… Zaktualizowano wersjÄ™ w manifest.json i hacs.json"

          git add manifest.json hacs.json
          git commit -m "build: update version to $VERSION" || echo "Brak zmian do commita"
          git push origin HEAD:main

      - name: ğŸ“¦ Create release ZIP
        run: |
          mkdir dist
          cp matches-card.js dist/
          cd dist
          zip -r ../matches-card-${{ github.event.inputs.version }}.zip .

      - name: ğŸš€ Publish GitHub release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.version }}
          name: Matches Card ${{ github.event.inputs.version }}
          body: |
            âœ… Automatyczny release wersji ${{ github.event.inputs.version }}

            **Zmiany:**
            - automatyczny commit scalonego pliku do repo (HACS compliance)
            - aktualizacja wersji w manifest.json i hacs.json
            - build Rollup z inline grafikami i tÅ‚umaczeniami
            - wydanie gotowe do instalacji przez HACS
          files: matches-card-${{ github.event.inputs.version }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}