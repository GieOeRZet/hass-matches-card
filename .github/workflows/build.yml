name: Build and release Matches Card

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Podaj numer wersji (np. 0.3.036)'
        required: true
  push:
    tags:
      - "v*"
      - "[0-9]+.[0-9]+.[0-9]+"

jobs:
  build-release:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ§° Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: ğŸ“¦ Install dependencies
        run: npm install

      - name: ğŸ—ï¸ Build card
        run: npm run build

      - name: ğŸ“ Update manifest.json & hacs.json version
        run: |
          VERSION=${{ github.event.inputs.version }}
          echo "ğŸ”– Ustawiam wersjÄ™: $VERSION"

          # podmiana w manifest.json
          if grep -q '"version":' manifest.json; then
            sed -i "s/\"version\": \".*\"/\"version\": \"$VERSION\"/" manifest.json
          else
            sed -i "1s/^/{\n  \"version\": \"$VERSION\",/" manifest.json
          fi

          # podmiana w hacs.json
          if grep -q '"version":' hacs.json; then
            sed -i "s/\"version\": \".*\"/\"version\": \"$VERSION\"/" hacs.json
          else
            sed -i "2i  \"version\": \"$VERSION\"," hacs.json
          fi

          echo "âœ… Zaktualizowano wersjÄ™ w manifest.json i hacs.json"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add manifest.json hacs.json
          git commit -m "build: update version to $VERSION" || echo "Brak zmian do commita"

      - name: ğŸ“¦ Create release ZIP
        run: zip -r matches-card-${{ github.event.inputs.version }}.zip matches-card.js

      - name: ğŸš€ Publish GitHub release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.version }}
          name: Matches Card ${{ github.event.inputs.version }}
          body: |
            âœ… Automatyczny release wersji ${{ github.event.inputs.version }}

            **NowoÅ›ci:**
            - Edytor z przyciskiem Reset ğŸ¨
            - Slider przezroczystoÅ›ci tÅ‚a
            - Mini podglÄ…dy kolorÃ³w jak w HA Theme Editor
            - Dynamiczne tÅ‚o karty (RGBA)
            - Zaktualizowano wersjÄ™ w manifest.json i hacs.json
          files: matches-card-${{ github.event.inputs.version }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
